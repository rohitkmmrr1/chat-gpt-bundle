<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCQ Selector Web App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6; /* bg-gray-100 */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            padding: 1rem; /* p-4 */
        }
        .container {
            width: 100%;
            max-width: 64rem; /* max-w-4xl */
        }
        /* Custom modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 400px;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        .error-message {
            color: #dc2626; /* text-red-600 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem; /* mt-1 */
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <script>
        // Utility for generating unique IDs
        const uuidv4 = () => {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        // Global state
        let currentView = 'list';
        let questions = [];

        // --- Custom Modal/Message Box Functions ---
        function showMessage(message, type = 'alert') {
            return new Promise((resolve) => {
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'modal-overlay';
                modalOverlay.innerHTML = `
                    <div class="modal-content">
                        <p class="text-lg font-semibold mb-4 text-gray-800">${message}</p>
                        <div class="modal-buttons">
                            <button id="modal-ok-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">OK</button>
                            ${type === 'confirm' ? `<button id="modal-cancel-btn" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out">Cancel</button>` : ''}
                        </div>
                    </div>
                `;
                document.body.appendChild(modalOverlay);

                document.getElementById('modal-ok-btn').onclick = () => {
                    document.body.removeChild(modalOverlay);
                    resolve(true);
                };
                if (type === 'confirm') {
                    document.getElementById('modal-cancel-btn').onclick = () => {
                        document.body.removeChild(modalOverlay);
                        resolve(false);
                    };
                }
            });
        }

        // --- Local Storage Functions ---
        const loadQuestions = () => {
            const savedQuestions = localStorage.getItem('mcqQuestions');
            if (savedQuestions) {
                questions = JSON.parse(savedQuestions);
            }
        };

        const saveQuestions = () => {
            localStorage.setItem('mcqQuestions', JSON.stringify(questions));
        };

        // --- Data Management Functions ---
        const addQuestion = (newQuestion) => {
            questions.push({ ...newQuestion, id: uuidv4() });
            saveQuestions();
            renderApp(); // Re-render the app after adding
        };

        const clearAllQuestions = async () => {
            const confirmed = await showMessage('Are you sure you want to clear all questions? This action cannot be undone.', 'confirm');
            if (confirmed) {
                questions = [];
                localStorage.removeItem('mcqQuestions');
                renderApp(); // Re-render the app after clearing
            }
        };

        const exportQuestions = () => {
            const dataStr = JSON.stringify(questions, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mcq_questions.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const importQuestions = async (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        // Basic validation for imported data structure
                        if (Array.isArray(importedData) && importedData.every(q => q.id && q.type && q.questionText)) {
                            const existingIds = new Set(questions.map(q => q.id));
                            const newQuestions = importedData.filter(q => !existingIds.has(q.id));
                            questions = [...questions, ...newQuestions];
                            saveQuestions();
                            await showMessage('Questions imported successfully!');
                            renderApp();
                        } else {
                            await showMessage('Invalid JSON file format. Please ensure it contains an array of question objects.');
                        }
                    } catch (error) {
                        console.error('Error parsing JSON:', error);
                        await showMessage('Error importing questions. Please ensure it is a valid JSON file.');
                    }
                };
                reader.readAsText(file);
            }
        };

        // --- Components Rendering ---

        // Helper to show/hide error messages
        const toggleErrorMessage = (elementId, message, show) => {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = show ? 'block' : 'none';
            }
        };

        // Question Form Component
        const renderQuestionForm = () => {
            const formContainer = document.createElement('div');
            formContainer.className = 'p-6 bg-white rounded-lg shadow-md max-w-2xl mx-auto my-8';
            formContainer.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">Add New Question</h2>
                <form id="question-form" class="space-y-6">
                    <div>
                        <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Question Type</label>
                        <select id="type" name="type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <option value="multiple-choice">Multiple Choice (Single Answer)</option>
                            <option value="multi-select">Multi-Select (Multiple Answers)</option>
                            <option value="match-the-following">Match the Following</option>
                        </select>
                    </div>

                    <div>
                        <label for="questionText" class="block text-sm font-medium text-gray-700 mb-1">Question Text</label>
                        <textarea id="questionText" name="questionText" rows="3" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter your question here..."></textarea>
                        <p id="questionText-error" class="error-message">Question text is required.</p>
                    </div>

                    <div>
                        <label for="imageText" class="block text-sm font-medium text-gray-700 mb-1">Optional Image URL/Text (e.g., for diagram)</label>
                        <input type="text" id="imageText" name="imageText" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter image URL or descriptive text (optional)">
                    </div>

                    <div id="options-container" class="space-y-4 hidden">
                        <h3 class="text-lg font-semibold text-gray-800">Options</h3>
                        <div id="option-fields-wrapper"></div>
                        <button type="button" id="add-option-btn" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                            Add Option
                        </button>
                        <p id="options-error" class="error-message">Please add at least one option.</p>
                        <p id="correct-answer-error" class="error-message">Please select a correct answer.</p>
                    </div>

                    <div id="matches-container" class="space-y-4 hidden">
                        <h3 class="text-lg font-semibold text-gray-800">Matches</h3>
                        <div id="match-fields-wrapper"></div>
                        <button type="button" id="add-match-btn" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                            Add Match Pair
                        </button>
                        <p id="matches-error" class="error-message">Please add at least one match pair.</p>
                        <p id="match-completeness-error" class="error-message">Please ensure all match pairs have both left and right items filled.</p>
                    </div>

                    <div class="flex justify-between items-center mt-8">
                        <button type="submit" class="flex-1 mr-2 px-6 py-3 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                            Add Question
                        </button>
                        <button type="button" id="back-to-list-btn" class="flex-1 ml-2 px-6 py-3 bg-gray-500 text-white font-semibold rounded-md shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                            Back to List
                        </button>
                    </div>
                </form>
            `;

            const form = formContainer.querySelector('#question-form');
            const typeSelect = formContainer.querySelector('#type');
            const questionTextarea = formContainer.querySelector('#questionText');
            const optionsContainer = formContainer.querySelector('#options-container');
            const matchesContainer = formContainer.querySelector('#matches-container');
            const optionFieldsWrapper = formContainer.querySelector('#option-fields-wrapper');
            const matchFieldsWrapper = formContainer.querySelector('#match-fields-wrapper');
            const addOptionBtn = formContainer.querySelector('#add-option-btn');
            const addMatchBtn = formContainer.querySelector('#add-match-btn');
            const backToListBtn = formContainer.querySelector('#back-to-list-btn');

            // Initial error state (hidden)
            toggleErrorMessage('questionText-error', '', false);
            toggleErrorMessage('options-error', '', false);
            toggleErrorMessage('correct-answer-error', '', false);
            toggleErrorMessage('matches-error', '', false);
            toggleErrorMessage('match-completeness-error', '', false);


            const updateFormVisibility = () => {
                const selectedType = typeSelect.value;
                optionsContainer.classList.add('hidden');
                matchesContainer.classList.add('hidden');

                if (selectedType === 'multiple-choice' || selectedType === 'multi-select') {
                    optionsContainer.classList.remove('hidden');
                } else if (selectedType === 'match-the-following') {
                    matchesContainer.classList.remove('hidden');
                }
            };

            const addOptionField = () => {
                const optionId = uuidv4();
                const optionDiv = document.createElement('div');
                optionDiv.className = 'flex items-center space-x-2';
                optionDiv.innerHTML = `
                    <input type="text" data-id="${optionId}" class="flex-grow shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Option ${optionFieldsWrapper.children.length + 1}" />
                    ${typeSelect.value === 'multiple-choice' ? `
                        <input type="radio" name="correctAnswer" value="${optionId}" class="form-radio h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" title="Mark as correct" />
                    ` : ''}
                    ${typeSelect.value === 'multi-select' ? `
                        <input type="checkbox" name="correctAnswers" value="${optionId}" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" title="Mark as correct" />
                    ` : ''}
                    <button type="button" class="p-2 text-red-600 hover:text-red-800 rounded-full focus:outline-none focus:ring-2 focus:ring-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                optionDiv.querySelector('button').onclick = () => {
                    optionDiv.remove();
                    // Re-evaluate options validity after removal
                    validateForm(false); // Don't submit, just validate
                };
                optionFieldsWrapper.appendChild(optionDiv);

                // Add input event listeners for validation feedback
                optionDiv.querySelector('input[type="text"]').oninput = () => validateForm(false);
                if (typeSelect.value === 'multiple-choice') {
                    optionDiv.querySelector('input[type="radio"]').onchange = () => validateForm(false);
                } else if (typeSelect.value === 'multi-select') {
                    optionDiv.querySelector('input[type="checkbox"]').onchange = () => validateForm(false);
                }
            };

            const addMatchField = () => {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'flex items-center space-x-2';
                matchDiv.innerHTML = `
                    <input type="text" data-type="left" class="flex-1 shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Left item ${matchFieldsWrapper.children.length + 1}" />
                    <span class="text-gray-600">-</span>
                    <input type="text" data-type="right" class="flex-1 shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Right item ${matchFieldsWrapper.children.length + 1}" />
                    <button type="button" class="p-2 text-red-600 hover:text-red-800 rounded-full focus:outline-none focus:ring-2 focus:ring-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                matchDiv.querySelector('button').onclick = () => {
                    matchDiv.remove();
                    validateForm(false); // Don't submit, just validate
                };
                matchDiv.querySelector('input[data-type="left"]').oninput = () => validateForm(false);
                matchDiv.querySelector('input[data-type="right"]').oninput = () => validateForm(false);
                matchFieldsWrapper.appendChild(matchDiv);
            };

            // Initial fields
            addOptionField();
            addOptionField();
            addMatchField();
            addMatchField();

            typeSelect.onchange = () => {
                updateFormVisibility();
                // Clear and re-add initial options/matches to reset radio/checkbox names
                optionFieldsWrapper.innerHTML = '';
                matchFieldsWrapper.innerHTML = '';
                addOptionField();
                addOptionField();
                addMatchField();
                addMatchField();
                validateForm(false); // Re-validate on type change
            };
            updateFormVisibility(); // Set initial visibility

            addOptionBtn.onclick = () => addOptionField();
            addMatchBtn.onclick = () => addMatchField();
            backToListBtn.onclick = () => { currentView = 'list'; renderApp(); };

            // Input event listener for question text
            questionTextarea.oninput = () => toggleErrorMessage('questionText-error', '', !questionTextarea.value.trim());


            const validateForm = (isSubmitAttempt = true) => {
                let isValid = true;

                // Validate Question Text
                if (!questionTextarea.value.trim()) {
                    toggleErrorMessage('questionText-error', 'Question text is required.', true);
                    isValid = false;
                } else {
                    toggleErrorMessage('questionText-error', '', false);
                }

                const type = typeSelect.value;

                if (type === 'multiple-choice' || type === 'multi-select') {
                    const options = [];
                    optionFieldsWrapper.querySelectorAll('.flex.items-center.space-x-2').forEach((optionDiv) => {
                        const input = optionDiv.querySelector('input[type="text"]');
                        if (input && input.value.trim() !== '') {
                            options.push({ id: input.dataset.id, text: input.value.trim() });
                        }
                    });

                    if (options.length === 0) {
                        toggleErrorMessage('options-error', 'Please add at least one option.', true);
                        isValid = false;
                    } else {
                        toggleErrorMessage('options-error', '', false);
                    }

                    if (type === 'multiple-choice') {
                        const correctAnswerRadio = form.querySelector('input[name="correctAnswer"]:checked');
                        if (!correctAnswerRadio) {
                            toggleErrorMessage('correct-answer-error', 'Please select a correct answer.', true);
                            isValid = false;
                        } else {
                            toggleErrorMessage('correct-answer-error', '', false);
                        }
                    } else if (type === 'multi-select') {
                        const correctAnswersCheckboxes = Array.from(form.querySelectorAll('input[name="correctAnswers"]:checked'));
                        if (correctAnswersCheckboxes.length === 0) {
                            toggleErrorMessage('correct-answer-error', 'Please select at least one correct answer.', true);
                            isValid = false;
                        } else {
                            toggleErrorMessage('correct-answer-error', '', false);
                        }
                    }
                } else if (type === 'match-the-following') {
                    const matches = [];
                    let allMatchesValid = true;
                    matchFieldsWrapper.querySelectorAll('.flex.items-center.space-x-2').forEach((matchDiv) => {
                        const leftInput = matchDiv.querySelector('input[data-type="left"]');
                        const rightInput = matchDiv.querySelector('input[data-type="right"]');
                        if (leftInput && rightInput) {
                            const leftVal = leftInput.value.trim();
                            const rightVal = rightInput.value.trim();
                            if (leftVal !== '' && rightVal !== '') {
                                matches.push({ left: leftVal, right: rightVal });
                            } else if (leftVal !== '' || rightVal !== '') {
                                allMatchesValid = false; // Partial input
                            }
                        }
                    });

                    if (matches.length === 0) {
                        toggleErrorMessage('matches-error', 'Please add at least one match pair.', true);
                        isValid = false;
                    } else {
                        toggleErrorMessage('matches-error', '', false);
                    }

                    if (!allMatchesValid) {
                        toggleErrorMessage('match-completeness-error', 'Please ensure all match pairs have both left and right items filled.', true);
                        isValid = false;
                    } else {
                        toggleErrorMessage('match-completeness-error', '', false);
                    }
                }

                return isValid;
            };

            form.onsubmit = async (event) => {
                event.preventDefault();

                if (!validateForm(true)) {
                    await showMessage('Please fix the errors in the form before submitting.');
                    return;
                }

                const questionText = questionTextarea.value.trim();
                const imageText = form.querySelector('#imageText').value.trim();
                const type = typeSelect.value;

                const newQuestion = {
                    type,
                    questionText,
                    imageText: imageText || undefined // Store only if not empty
                };

                if (type === 'multiple-choice') {
                    const options = [];
                    optionFieldsWrapper.querySelectorAll('.flex.items-center.space-x-2').forEach((optionDiv) => {
                        const input = optionDiv.querySelector('input[type="text"]');
                        if (input && input.value.trim() !== '') {
                            options.push({ id: input.dataset.id, text: input.value.trim() });
                        }
                    });
                    const correctAnswerRadio = form.querySelector('input[name="correctAnswer"]:checked');
                    newQuestion.options = options;
                    newQuestion.correctAnswer = correctAnswerRadio.value;
                } else if (type === 'multi-select') {
                    const options = [];
                    optionFieldsWrapper.querySelectorAll('.flex.items-center.space-x-2').forEach((optionDiv) => {
                        const input = optionDiv.querySelector('input[type="text"]');
                        if (input && input.value.trim() !== '') {
                            options.push({ id: input.dataset.id, text: input.value.trim() });
                        }
                    });
                    const correctAnswersCheckboxes = Array.from(form.querySelectorAll('input[name="correctAnswers"]:checked')).map(cb => cb.value);
                    newQuestion.options = options;
                    newQuestion.correctAnswers = correctAnswersCheckboxes;
                } else if (type === 'match-the-following') {
                    const matches = [];
                    matchFieldsWrapper.querySelectorAll('.flex.items-center.space-x-2').forEach((matchDiv) => {
                        const leftInput = matchDiv.querySelector('input[data-type="left"]');
                        const rightInput = matchDiv.querySelector('input[data-type="right"]');
                        if (leftInput && rightInput && leftInput.value.trim() !== '' && rightInput.value.trim() !== '') {
                            matches.push({ left: leftInput.value.trim(), right: rightInput.value.trim() });
                        }
                    });
                    newQuestion.matches = matches;
                }

                addQuestion(newQuestion);
                form.reset();
                optionFieldsWrapper.innerHTML = ''; // Clear options
                matchFieldsWrapper.innerHTML = ''; // Clear matches
                addOptionField(); // Add initial options back
                addOptionField();
                addMatchField();
                addMatchField();
                toggleErrorMessage('questionText-error', '', false); // Clear errors on reset
                toggleErrorMessage('options-error', '', false);
                toggleErrorMessage('correct-answer-error', '', false);
                toggleErrorMessage('matches-error', '', false);
                toggleErrorMessage('match-completeness-error', '', false);
                currentView = 'list';
                renderApp();
            };

            return formContainer;
        };

        // Question List Component
        const renderQuestionList = () => {
            const listContainer = document.createElement('div');
            listContainer.className = 'p-6 bg-white rounded-lg shadow-md max-w-4xl mx-auto my-8';
            listContainer.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">Your Questions</h2>

                <div class="flex justify-center flex-wrap gap-4 mb-8">
                    <button id="add-question-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                        Add New Question
                    </button>
                    <button id="start-test-btn" class="px-6 py-3 font-semibold rounded-md shadow-md transition duration-150 ease-in-out ${questions.length === 0 ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2'}">
                        Start Test (${questions.length} Questions)
                    </button>
                    <button id="export-questions-btn" class="px-6 py-3 font-semibold rounded-md shadow-md transition duration-150 ease-in-out ${questions.length === 0 ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2'}">
                        Export Questions
                    </button>
                    <label class="px-6 py-3 font-semibold rounded-md shadow-md cursor-pointer transition duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
                        Import Questions
                        <input type="file" id="import-questions-input" accept=".json" class="hidden" />
                    </label>
                    <button id="clear-all-btn" class="px-6 py-3 font-semibold rounded-md shadow-md transition duration-150 ease-in-out ${questions.length === 0 ? 'bg-gray-400 cursor-not-allowed' : 'bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2'}">
                        Clear All Questions
                    </button>
                </div>

                <div id="question-list-display" class="space-y-4">
                    ${questions.length === 0 ? `
                        <p class="text-center text-gray-600 text-lg">No questions added yet. Click "Add New Question" to get started!</p>
                    ` : ''}
                </div>
            `;

            listContainer.querySelector('#add-question-btn').onclick = () => { currentView = 'add'; renderApp(); };
            listContainer.querySelector('#start-test-btn').onclick = () => {
                if (questions.length > 0) {
                    currentView = 'test';
                    renderApp();
                }
            };
            listContainer.querySelector('#export-questions-btn').onclick = () => exportQuestions();
            listContainer.querySelector('#import-questions-input').onchange = (event) => importQuestions(event);
            listContainer.querySelector('#clear-all-btn').onclick = () => clearAllQuestions();

            const questionListDisplay = listContainer.querySelector('#question-list-display');
            if (questions.length > 0) {
                questions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'bg-gray-50 p-4 rounded-md shadow-sm border border-gray-200';
                    let contentHtml = `
                        <p class="text-sm font-semibold text-gray-700 mb-1">Question ${index + 1} (Type: ${q.type.replace(/-/g, ' ').replace(/\b\w/g, char => char.toUpperCase())})</p>
                        <p class="text-md font-medium text-gray-900 mb-2">${q.questionText}</p>
                        ${q.imageText ? `<p class="text-sm text-gray-500 italic mb-2">Image/Text: ${q.imageText}</p>` : ''}
                    `;

                    if (q.type === 'multiple-choice') {
                        contentHtml += `<ul class="list-disc list-inside text-sm text-gray-700">`;
                        q.options.forEach(opt => {
                            contentHtml += `<li class="${opt.id === q.correctAnswer ? 'font-bold text-green-700' : ''}">${opt.text} ${opt.id === q.correctAnswer ? '(Correct)' : ''}</li>`;
                        });
                        contentHtml += `</ul>`;
                    } else if (q.type === 'multi-select') {
                        contentHtml += `<ul class="list-disc list-inside text-sm text-gray-700">`;
                        q.options.forEach(opt => {
                            contentHtml += `<li class="${q.correctAnswers.includes(opt.id) ? 'font-bold text-green-700' : ''}">${opt.text} ${q.correctAnswers.includes(opt.id) ? '(Correct)' : ''}</li>`;
                        });
                        contentHtml += `</ul>`;
                    } else if (q.type === 'match-the-following') {
                        contentHtml += `<div class="grid grid-cols-2 gap-2 text-sm text-gray-700">`;
                        q.matches.forEach((match, i) => {
                            contentHtml += `
                                <div class="flex justify-between">
                                    <span class="font-medium">${match.left}</span>
                                    <span>-</span>
                                    <span>${match.right}</span>
                                </div>
                            `;
                        });
                        contentHtml += `</div>`;
                    }
                    questionDiv.innerHTML = contentHtml;
                    questionListDisplay.appendChild(questionDiv);
                });
            }

            return listContainer;
        };

        // Test Screen Component
        const renderTestScreen = () => {
            const testScreenContainer = document.createElement('div');
            testScreenContainer.className = 'p-6 bg-white rounded-lg shadow-md max-w-2xl mx-auto my-8';

            let shuffledQuestions = [];
            let currentQuestionIndex = 0;
            let userAnswers = {}; // { questionId: userAnswer }
            let score = 0;
            let showResults = false;

            const initializeTest = () => {
                shuffledQuestions = [...questions].sort(() => Math.random() - 0.5);
                currentQuestionIndex = 0;
                userAnswers = {};
                score = 0;
                showResults = false;
                renderTestContent();
            };

            const handleAnswerChange = (questionId, answer) => {
                userAnswers[questionId] = answer;
            };

            const checkAnswer = () => {
                const currentQuestion = shuffledQuestions[currentQuestionIndex];
                if (!currentQuestion) return false;

                const userAnswer = userAnswers[currentQuestion.id];
                if (currentQuestion.type === 'multiple-choice') {
                    return userAnswer === currentQuestion.correctAnswer;
                } else if (currentQuestion.type === 'multi-select') {
                    const userSelected = new Set(userAnswer || []);
                    const correctSelected = new Set(currentQuestion.correctAnswers || []);
                    if (userSelected.size !== correctSelected.size) return false;
                    for (let item of userSelected) {
                        if (!correctSelected.has(item)) return false;
                    }
                    return true;
                } else if (currentQuestion.type === 'match-the-following') {
                    if (!userAnswer) return false;
                    return currentQuestion.matches.every(match => userAnswer[match.left] === match.right);
                }
                return false;
            };

            const handleNextQuestion = () => {
                if (checkAnswer()) {
                    score++;
                }

                if (currentQuestionIndex < shuffledQuestions.length - 1) {
                    currentQuestionIndex++;
                    renderTestContent();
                } else {
                    showResults = true;
                    renderTestContent(); // Render results
                }
            };

            const renderQuestionContent = () => {
                const currentQuestion = shuffledQuestions[currentQuestionIndex];
                if (!currentQuestion) return '';

                let questionHtml = `
                    <p class="text-lg font-semibold mb-4">${currentQuestion.questionText}</p>
                    ${currentQuestion.imageText ? `<p class="text-sm text-gray-500 italic mb-4">Image/Text: ${currentQuestion.imageText}</p>` : ''}
                `;

                if (currentQuestion.type === 'multiple-choice') {
                    questionHtml += `<div class="space-y-2">`;
                    currentQuestion.options.forEach(option => {
                        const checked = userAnswers[currentQuestion.id] === option.id ? 'checked' : '';
                        questionHtml += `
                            <label class="flex items-center p-3 border border-gray-300 rounded-md cursor-pointer hover:bg-gray-50 transition duration-150 ease-in-out">
                                <input type="radio" name="question-${currentQuestion.id}" value="${option.id}" ${checked} class="form-radio h-5 w-5 text-indigo-600 border-gray-300 focus:ring-indigo-500" />
                                <span class="ml-3 text-gray-800">${option.text}</span>
                            </label>
                        `;
                    });
                    questionHtml += `</div>`;
                } else if (currentQuestion.type === 'multi-select') {
                    questionHtml += `<div class="space-y-2">`;
                    currentQuestion.options.forEach(option => {
                        const checked = (userAnswers[currentQuestion.id] || []).includes(option.id) ? 'checked' : '';
                        questionHtml += `
                            <label class="flex items-center p-3 border border-gray-300 rounded-md cursor-pointer hover:bg-gray-50 transition duration-150 ease-in-out">
                                <input type="checkbox" name="question-${currentQuestion.id}" value="${option.id}" ${checked} class="form-checkbox h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" />
                                <span class="ml-3 text-gray-800">${option.text}</span>
                            </label>
                        `;
                    });
                    questionHtml += `</div>`;
                } else if (currentQuestion.type === 'match-the-following') {
                    questionHtml += `
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-1 space-y-3">
                                <h4 class="font-medium text-gray-700">Left Column</h4>
                                ${currentQuestion.matches.map(match => `
                                    <div class="p-3 border border-gray-300 rounded-md bg-gray-50">${match.left}</div>
                                `).join('')}
                            </div>
                            <div class="col-span-1 space-y-3">
                                <h4 class="font-medium text-gray-700">Your Matches</h4>
                                ${currentQuestion.matches.map(match => `
                                    <input type="text" data-left-item="${match.left}" placeholder="Enter match" value="${(userAnswers[currentQuestion.id] && userAnswers[currentQuestion.id][match.left]) || ''}" class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" />
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                return questionHtml;
            };

            const renderTestContent = () => {
                testScreenContainer.innerHTML = ''; // Clear previous content

                if (shuffledQuestions.length === 0) {
                    testScreenContainer.className = 'p-6 bg-white rounded-lg shadow-md max-w-2xl mx-auto my-8 text-center';
                    testScreenContainer.innerHTML = `
                        <p class="text-lg text-gray-600 mb-4">No questions available to start the test. Please add some questions first.</p>
                        <button id="test-back-to-list-btn" class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-md shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                            Back to List
                        </button>
                    `;
                    testScreenContainer.querySelector('#test-back-to-list-btn').onclick = () => { currentView = 'list'; renderApp(); };
                    return;
                }

                if (showResults) {
                    testScreenContainer.className = 'p-6 bg-white rounded-lg shadow-md max-w-2xl mx-auto my-8 text-center';
                    testScreenContainer.innerHTML = `
                        <h2 class="text-3xl font-bold mb-6 text-indigo-700">Test Results</h2>
                        <p class="text-xl text-gray-800 mb-4">You scored: <span class="font-bold text-green-600">${score}</span> out of <span class="font-bold">${shuffledQuestions.length}</span></p>
                        <button id="test-back-to-home-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                            Back to Home
                        </button>
                    `;
                    testScreenContainer.querySelector('#test-back-to-home-btn').onclick = () => { currentView = 'list'; renderApp(); };
                    return;
                }

                const currentQuestion = shuffledQuestions[currentQuestionIndex];
                testScreenContainer.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">
                        Question ${currentQuestionIndex + 1} of ${shuffledQuestions.length}
                    </h2>
                    <div id="question-content">
                        ${renderQuestionContent()}
                    </div>
                    <div class="flex justify-between items-center mt-8">
                        <button id="next-question-btn" class="flex-1 mr-2 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                            ${currentQuestionIndex < shuffledQuestions.length - 1 ? 'Next Question' : 'Finish Test'}
                        </button>
                        <button id="exit-test-btn" class="flex-1 ml-2 px-6 py-3 bg-gray-500 text-white font-semibold rounded-md shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                            Exit Test
                        </button>
                    </div>
                `;

                // Add event listeners for the current question type
                if (currentQuestion.type === 'multiple-choice') {
                    testScreenContainer.querySelectorAll(`input[name="question-${currentQuestion.id}"]`).forEach(radio => {
                        radio.onchange = (e) => handleAnswerChange(currentQuestion.id, e.target.value);
                    });
                } else if (currentQuestion.type === 'multi-select') {
                    testScreenContainer.querySelectorAll(`input[name="question-${currentQuestion.id}"]`).forEach(checkbox => {
                        checkbox.onchange = (e) => {
                            let currentSelections = userAnswers[currentQuestion.id] || [];
                            if (e.target.checked) {
                                handleAnswerChange(currentQuestion.id, [...currentSelections, e.target.value]);
                            } else {
                                handleAnswerChange(currentQuestion.id, currentSelections.filter(id => id !== e.target.value));
                            }
                        };
                    });
                } else if (currentQuestion.type === 'match-the-following') {
                    testScreenContainer.querySelectorAll('input[data-left-item]').forEach(input => {
                        input.oninput = (e) => {
                            const leftItem = e.target.dataset.leftItem;
                            handleAnswerChange(currentQuestion.id, {
                                ...(userAnswers[currentQuestion.id] || {}),
                                [leftItem]: e.target.value
                            });
                        };
                    });
                }

                testScreenContainer.querySelector('#next-question-btn').onclick = handleNextQuestion;
                testScreenContainer.querySelector('#exit-test-btn').onclick = () => { currentView = 'list'; renderApp(); };
            };

            // Initial call to set up the test
            initializeTest();
            return testScreenContainer;
        };


        // --- Main Application Renderer ---
        const renderApp = () => {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = ''; // Clear existing content

            if (currentView === 'list') {
                appDiv.appendChild(renderQuestionList());
            } else if (currentView === 'add') {
                appDiv.appendChild(renderQuestionForm());
            } else if (currentView === 'test') {
                appDiv.appendChild(renderTestScreen());
            }
        };

        // Initial load and render
        window.onload = () => {
            loadQuestions();
            renderApp();
        };
    </script>
</body>
</html>
